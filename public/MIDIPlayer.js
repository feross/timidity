var A=Object.create;var m=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var B=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var F=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of I(e))!W.call(t,s)&&s!==n&&m(t,s,{get:()=>e[s],enumerable:!(r=P(e,s))||r.enumerable});return t};var K=(t,e,n)=>(n=t!=null?A(T(t)):{},F(e||!t||!t.__esModule?m(n,"default",{value:t,enumerable:!0}):n,t));var M=B((J,d)=>{"use strict";var a=typeof Reflect=="object"?Reflect:null,y=a&&typeof a.apply=="function"?a.apply:function(e,n,r){return Function.prototype.apply.call(e,n,r)},l;a&&typeof a.ownKeys=="function"?l=a.ownKeys:Object.getOwnPropertySymbols?l=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:l=function(e){return Object.getOwnPropertyNames(e)};function U(t){console&&console.warn&&console.warn(t)}var g=Number.isNaN||function(e){return e!==e};function o(){o.init.call(this)}d.exports=o,d.exports.once=H,o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var w=10;function p(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return w},set:function(t){if(typeof t!="number"||t<0||g(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");w=t}}),o.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||g(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function L(t){return t._maxListeners===void 0?o.defaultMaxListeners:t._maxListeners}o.prototype.getMaxListeners=function(){return L(this)},o.prototype.emit=function(e){for(var n=[],r=1;r<arguments.length;r++)n.push(arguments[r]);var s=e==="error",f=this._events;if(f!==void 0)s=s&&f.error===void 0;else if(!s)return!1;if(s){var i;if(n.length>0&&(i=n[0]),i instanceof Error)throw i;var u=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw u.context=i,u}var c=f[e];if(c===void 0)return!1;if(typeof c=="function")y(c,this,n);else for(var v=c.length,k=O(c,v),r=0;r<v;++r)y(k[r],this,n);return!0};function _(t,e,n,r){var s,f,i;if(p(n),f=t._events,f===void 0?(f=t._events=Object.create(null),t._eventsCount=0):(f.newListener!==void 0&&(t.emit("newListener",e,n.listener?n.listener:n),f=t._events),i=f[e]),i===void 0)i=f[e]=n,++t._eventsCount;else if(typeof i=="function"?i=f[e]=r?[n,i]:[i,n]:r?i.unshift(n):i.push(n),s=L(t),s>0&&i.length>s&&!i.warned){i.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=i.length,U(u)}return t}o.prototype.addListener=function(e,n){return _(this,e,n,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,n){return _(this,e,n,!0)};function S(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function b(t,e,n){var r={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},s=S.bind(r);return s.listener=n,r.wrapFn=s,s}o.prototype.once=function(e,n){return p(n),this.on(e,b(this,e,n)),this},o.prototype.prependOnceListener=function(e,n){return p(n),this.prependListener(e,b(this,e,n)),this},o.prototype.removeListener=function(e,n){var r,s,f,i,u;if(p(n),s=this._events,s===void 0)return this;if(r=s[e],r===void 0)return this;if(r===n||r.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,r.listener||n));else if(typeof r!="function"){for(f=-1,i=r.length-1;i>=0;i--)if(r[i]===n||r[i].listener===n){u=r[i].listener,f=i;break}if(f<0)return this;f===0?r.shift():$(r,f),r.length===1&&(s[e]=r[0]),s.removeListener!==void 0&&this.emit("removeListener",e,u||n)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var n,r,s;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var f=Object.keys(r),i;for(s=0;s<f.length;++s)i=f[s],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=r[e],typeof n=="function")this.removeListener(e,n);else if(n!==void 0)for(s=n.length-1;s>=0;s--)this.removeListener(e,n[s]);return this};function x(t,e,n){var r=t._events;if(r===void 0)return[];var s=r[e];return s===void 0?[]:typeof s=="function"?n?[s.listener||s]:[s]:n?D(s):O(s,s.length)}o.prototype.listeners=function(e){return x(this,e,!0)},o.prototype.rawListeners=function(e){return x(this,e,!1)},o.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):E.call(t,e)},o.prototype.listenerCount=E;function E(t){var e=this._events;if(e!==void 0){var n=e[t];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}o.prototype.eventNames=function(){return this._eventsCount>0?l(this._events):[]};function O(t,e){for(var n=new Array(e),r=0;r<e;++r)n[r]=t[r];return n}function $(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function D(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}function H(t,e){return new Promise(function(n,r){function s(i){t.removeListener(e,f),r(i)}function f(){typeof t.removeListener=="function"&&t.removeListener("error",s),n([].slice.call(arguments))}C(t,e,f,{once:!0}),e!=="error"&&q(t,s,{once:!0})})}function q(t,e,n){typeof t.on=="function"&&C(t,"error",e,n)}function C(t,e,n,r){if(typeof t.on=="function")r.once?t.once(e,n):t.on(e,n);else if(typeof t.addEventListener=="function")t.addEventListener(e,function s(f){r.once&&t.removeEventListener(e,s),n(f)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}});var j=K(M()),h=class extends j.EventEmitter{constructor(e,n,r){super(),this._worklet=e,this._baseURL=r,this._worklet.port.onmessage=this._handleMessage.bind(this),this.context=n,this._worklet.connect(n.destination)}async _handleMessage(e){if(e.data.type==="missingInstruments"){let n=[];try{n=await Promise.all(e.data.instruments.map(r=>this.fetchInstrument(r)))}catch(r){console.log("Error loading instrument patch files"),console.log(r)}this._worklet.port.postMessage({type:"instPayload",buffs:n})}else e.data==="loaded"&&this.emit("song-loaded")}play(){this.context.resume(),this._worklet.port.postMessage("play")}pause(){this._worklet.port.postMessage("pause")}seek(e){this._worklet.port.postMessage({type:"seek",sec:e})}async load(e){let n=await R(e);this._worklet.port.postMessage({type:"loadMIDI",midiBuff:n}),await new Promise((r,s)=>{this.on("song-loaded",()=>r()),setTimeout(()=>s("timeout on loading midi song instruments, 5000"),5e3)})}async fetchInstrument(e){let n=this._baseURL+e;return/(?:\.([^.]+))?$/.exec(e)!=="pat"&&(n=this._baseURL+e+".pat"),{instrumentName:e,instrumentBuff:await R(n)}}};async function R(t){let n=await(await N(t)).arrayBuffer();return new Uint8Array(n)}async function z(t){return await(await N(t)).text()}async function N(t){let e={mode:"cors",credentials:"same-origin"},n=await window.fetch(t,e);if(n.status!==200)throw new Error(`Could not load ${t}`);return n}async function Q(t="/",e=new AudioContext){try{await e.audioWorklet.addModule(t+"TimidityWorkletProcessor.js")}catch(s){console.log(s)}let n=await z(t+"gravis.cfg"),r=new AudioWorkletNode(e,"midiplayer",{outputChannelCount:[2],processorOptions:{baseURL:t,timidityCfg:n}});return new h(r,e,t)}export{h as MIDIPlayer,Q as createMIDIPlayer,z as fetchText};
//# sourceMappingURL=MIDIPlayer.js.map
